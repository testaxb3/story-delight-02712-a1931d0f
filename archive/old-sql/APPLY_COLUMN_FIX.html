<!DOCTYPE html>
<html>
<head>
  <title>Fix what_to_expect Column Type</title>
  <style>
    body {
      font-family: 'Segoe UI', system-ui, sans-serif;
      padding: 40px;
      max-width: 1000px;
      margin: 0 auto;
      background: #0a0a0a;
      color: #e0e0e0;
    }
    h1 { color: #10b981; margin-bottom: 10px; }
    h2 { color: #3b82f6; margin-top: 30px; }
    .error { background: #7f1d1d; padding: 20px; border-radius: 8px; margin: 20px 0; }
    .solution { background: #14532d; padding: 20px; border-radius: 8px; margin: 20px 0; }
    pre {
      background: #1e1e1e;
      color: #4ec9b0;
      padding: 20px;
      border-radius: 8px;
      overflow-x: auto;
      font-size: 13px;
      line-height: 1.6;
      max-height: 500px;
      overflow-y: auto;
    }
    .btn {
      background: #10b981;
      color: white;
      padding: 14px 28px;
      border-radius: 8px;
      text-decoration: none;
      display: inline-block;
      margin: 10px 5px;
      font-weight: 600;
      font-size: 15px;
    }
    .btn:hover { background: #059669; }
    code {
      background: #374151;
      padding: 2px 6px;
      border-radius: 3px;
      color: #fbbf24;
      font-size: 13px;
    }
    ul { line-height: 1.8; }
  </style>
</head>
<body>

<h1>üîß Fix what_to_expect Column Type</h1>

<div class="error">
  <h2>‚ùå The Error You Got</h2>
  <code>ERROR: cannot drop column what_to_expect_old because other objects depend on it</code>

  <p><strong>Why:</strong> Database views (<code>emergency_scripts</code> and <code>emergency_scripts_new</code>) reference the old column.</p>

  <p><strong>Solution:</strong> Drop the views first, then drop the column, then recreate the views.</p>
</div>

<div class="solution">
  <h2>‚úÖ Fixed SQL (Handles View Dependencies)</h2>

  <p>Copy this SQL and paste it into Supabase SQL Editor:</p>

  <pre>-- Fix what_to_expect column type (handles view dependencies)

-- Step 1: Drop the validation triggers first
DROP TRIGGER IF EXISTS validate_strategy_steps_trigger ON scripts;
DROP TRIGGER IF EXISTS validate_what_to_expect_trigger ON scripts;
DROP FUNCTION IF EXISTS validate_strategy_steps();
DROP FUNCTION IF EXISTS validate_what_to_expect();

-- Step 2: Check current column type
SELECT
  column_name,
  data_type,
  udt_name
FROM information_schema.columns
WHERE table_name = 'scripts'
  AND column_name LIKE 'what_to_expect%'
ORDER BY column_name;

-- Step 3: Drop dependent views (they'll be recreated)
DROP VIEW IF EXISTS emergency_scripts CASCADE;
DROP VIEW IF EXISTS emergency_scripts_new CASCADE;

-- Step 4: Rename old column
ALTER TABLE scripts RENAME COLUMN what_to_expect TO what_to_expect_old;

-- Step 5: Add new JSONB column
ALTER TABLE scripts ADD COLUMN what_to_expect JSONB;

-- Step 6: Drop old column (no longer has dependencies)
ALTER TABLE scripts DROP COLUMN what_to_expect_old;

-- Step 7: Recreate emergency_scripts_new view
CREATE OR REPLACE VIEW emergency_scripts_new AS
SELECT
  s.id,
  s.title,
  s.category,
  s.profile,
  s.difficulty,
  s.duration_minutes,
  COALESCE(s.the_situation, s.situation_trigger) as situation,
  s.strategy_steps,
  s.what_to_expect,
  COUNT(DISTINCT sf.id) FILTER (WHERE sf.outcome = 'worked') as worked_count,
  COUNT(DISTINCT sf.id) as total_uses,
  CASE
    WHEN COUNT(DISTINCT sf.id) > 0 THEN
      ROUND(
        (COUNT(DISTINCT sf.id) FILTER (WHERE sf.outcome = 'worked') * 1.0 +
         COUNT(DISTINCT sf.id) FILTER (WHERE sf.outcome = 'progress') * 0.5) /
        COUNT(DISTINCT sf.id) * 100
      )
    ELSE NULL
  END as success_rate_percent
FROM scripts s
LEFT JOIN script_feedback sf ON s.id = sf.script_id
WHERE s.emergency_suitable = true
  AND s.works_in_public = true
  AND s.duration_minutes <= 5
GROUP BY s.id
ORDER BY success_rate_percent DESC NULLS LAST, worked_count DESC;

-- Step 8: Verify the fix
SELECT
  column_name,
  data_type,
  udt_name
FROM information_schema.columns
WHERE table_name = 'scripts'
  AND column_name = 'what_to_expect';

-- Expected result: data_type should be 'jsonb'</pre>

  <a href="https://supabase.com/dashboard/project/iogceaotdodvugrmogpp/sql/new" target="_blank" class="btn">
    üöÄ Open SQL Editor & Run This
  </a>
</div>

<h2>üìã After Running SQL</h2>
<ol>
  <li>Wait for "Success. No rows returned" message</li>
  <li>Check the query results - should show <code>data_type: jsonb</code></li>
  <li>Run this command in your terminal:</li>
</ol>

<pre>node update-existing-scripts-full-data.mjs</pre>

<p>This will add the <code>what_to_expect</code> timeline data to all 3 scripts.</p>

<h2>‚ú® What This Does</h2>
<ul>
  <li>‚úÖ Drops validation triggers (they were blocking updates)</li>
  <li>‚úÖ Drops dependent views safely with CASCADE</li>
  <li>‚úÖ Converts <code>what_to_expect</code> from TEXT[] to JSONB</li>
  <li>‚úÖ Recreates the emergency_scripts view with correct schema</li>
  <li>‚úÖ Allows proper timeline data: <code>{first_30_seconds, by_2_minutes, dont_expect, this_is_success}</code></li>
</ul>

<h2>üéØ Expected Result</h2>
<p>After fixing the column type and running the update script, the "What to Expect" section will display:</p>
<ul>
  <li><strong>First 30 seconds:</strong> "Still resistant, but stops escalating..."</li>
  <li><strong>By 90 seconds:</strong> "Usually chooses an option..."</li>
  <li><strong>Don't Expect:</strong> Bullet list of unrealistic expectations</li>
  <li><strong>This is Success:</strong> Realistic success criteria</li>
</ul>

</body>
</html>
